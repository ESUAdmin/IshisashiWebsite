<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>等差分纬线多圆锥投影（伪）</title>
    </head>
    <body>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="https://unpkg.com/topojson@3"></script>
        <form onsubmit="return false">
            <ul>
                <li><label>Width</label> <input type="number" id="width" value="954"></li>
                <li><label>Height</label> <input type="number" id="height" value="600"></li>
                <li><label>Lambda</label> <input type="number" id="lambda" value="-150"></li>
                <li><label>Phi</label> <input type="number" id="phi" value="0"></li>
                <li><label>Gamma</label> <input type="number" id="gamma" value="0"></li>
                <li><label>Angle</label> <input type="number" id="angle" value="0"></li>
            </ul>
            <button onclick="return reload() && false">Reload</button>
        </form>
        <script>
            let svg = d3.select('body').append('svg');
            // 郝晓光《经纬跨越四百年》附录 1
            let projection = d3.geoProjection((lon, lat) => {
                let phi = (180 / Math.PI) * lat;
                let b = 1.1;
                let c = 0.02893726;
                let y0 = (1.1068 * phi + 0.000005 * phi ** 3) / 3.3;
                let yn = 0.505942 * phi - 2.447552e-5 * phi ** 3 + 1.164925e-9 * phi ** 5;
                let xn = Math.sqrt(2450.25 - 1.625 * yn ** 2) + 0.5;
                let rho = (xn ** 2 + (yn - y0) ** 2) / (2 * (yn - y0));
                let deltaPi = Math.asin(xn / rho);
                // 加上绝对值以使左右对称
                let delta = deltaPi * b * (1 - c * Math.abs(lon)) * lon / Math.PI;
                let y = lat === 0 ? 0 : y0 + rho * (1 - Math.cos(delta));
                let x = lat === 0 ? xn * b * (1 - c * Math.abs(lon)) * lon / Math.PI : rho * Math.sin(delta);
                return [x, y];
            });
            let path = d3.geoPath(projection);
            let graticule = d3.geoGraticule10();
            let outline = { type: 'Sphere' };
            projection.fitExtent([[0.5, 0.5], [svg.attr('width') - 0.5, svg.attr('height') - 0.5]], outline);
            let world;
            const reload = () => {
                svg.html(null);
                svg.attr('width', document.getElementById('width').value).attr('height', document.getElementById('height').value);
                projection.rotate([Number(document.getElementById('lambda').value), Number(document.getElementById('phi').value), Number(document.getElementById('gamma').value)])
                projection.angle([Number(document.getElementById('angle').value)]);
                projection.fitExtent([[0.5, 0.5], [svg.attr('width') - 0.5, svg.attr('height') - 0.5]], outline);
                svg.append('path').datum(graticule).attr('class', 'graticule').attr('d', path).attr('stroke', '#808080').attr('fill', 'none');
                svg.append('path').datum(topojson.feature(world, world.objects.land)).attr('class', 'land').attr('d', path);
                svg.append('path').datum(outline).attr('class', 'outline').attr('d', path).attr('stroke', '#000000').attr('fill', 'none');
            };
            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json').then((json) => {
                world = json;
                reload();
            });
        </script>
    </body>
</html>
